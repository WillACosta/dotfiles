#!/usr/bin/env zsh
# delete-node-modules.zsh
# Recursively find and delete all node_modules directories under the current directory
# WITHOUT descending into node_modules themselves (so we avoid traversing huge trees).
#
# Usage:
#   ./delete-node-modules.zsh      # interactive (asks for confirmation)
#   DRY_RUN=1 ./delete-node-modules.zsh   # show what would be deleted
#   FORCE=1 ./delete-node-modules.zsh     # delete without prompt

setopt localoptions nullglob  # let globs that match nothing expand to nothing

typeset -a dirs_to_visit
typeset -a found
dirs_to_visit=(.)   # start at current directory

# Breadth-first traversal (we append children) but never descend into node_modules
for (( i = 1; i <= ${#dirs_to_visit}; i++ )); do
  current=${dirs_to_visit[i]}

  # Expand only directories inside $current (include dot dirs? use D qualifier if needed)
  for child in "$current"/*(/N); do
    # if child is a node_modules directory, collect it and DO NOT push it for further traversal
    if [[ ${child:t} == "node_modules" ]]; then
      found+=("$child")
    else
      # push directory for future traversal
      dirs_to_visit+=("$child")
    fi
  done
done

if (( ${#found} == 0 )); then
  echo "No node_modules directories found under: $(pwd)"
  exit 0
fi

echo "Found ${#found} node_modules directories:"
for d in "${found[@]}"; do
  echo "  $d"
done

# If DRY_RUN=1 is set, just show and exit
if [[ -n $DRY_RUN ]]; then
  echo
  echo "DRY RUN enabled. No deletion performed."
  exit 0
fi

# Confirm unless FORCE=1
if [[ -z $FORCE ]]; then
  echo
  read "reply?Delete all listed node_modules directories? (y/N) "
  if [[ ! $reply =~ ^[Yy]$ ]]; then
    echo "Aborted."
    exit 1
  fi
fi

echo
# Delete (careful). Use '--' to safely handle names starting with '-'
for d in "${found[@]}"; do
  echo "Deleting: $d"
  rm -rf -- "$d"
done

echo
echo "Done. Deleted ${#found} node_modules directories."
